<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mindful Talk (V25 Final)</title>
    <style>
        :root {
            /* è«å…°è¿ªÂ·å¤§åœ°è‰²ç³» */
            --bg-a: #F2F7F2;  /* ææµ…ç°ç»¿ */
            --text-a: #5D7A50;
            --bg-b: #FFF9F5;  /* ææµ…æš–æ */
            --text-b: #C97C5D;
            --primary: #7A9A6E;
            --accent: #DFA656;
            --text-main: #333;
            --text-sub: #999;
            --white: #ffffff;
            --gray-bg: #F9F9F9;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", Roboto, sans-serif;
            background-color: #222; margin: 0; 
            display: flex; justify-content: center; height: 100vh; overflow: hidden;
        }

        #app-container {
            width: 100%; max-width: 420px; height: 100%;
            background: var(--white);
            position: relative; display: flex; flex-direction: column;
        }

        /* å±å¹•å®¹å™¨ */
        .screen {
            flex: 1; position: relative; overflow-y: auto; overflow-x: hidden;
            display: none; flex-direction: column;
            padding: 24px; padding-bottom: 90px;
            animation: fadeIn 0.4s ease;
        }
        .screen.active { display: flex; }
        .screen::-webkit-scrollbar { display: none; }

        /* === é¦–é¡µ === */
        .home-header { margin-top: 60px; text-align: center; }
        .home-title { font-size: 28px; color: var(--text-a); letter-spacing: 2px; font-weight: 300; }
        .home-sub { font-size: 12px; color: var(--text-sub); letter-spacing: 4px; margin-top: 8px; text-transform: uppercase; }
        
        .start-circle {
            width: 140px; height: 140px; border-radius: 50%;
            background: var(--bg-a); border: 2px solid var(--text-a);
            color: var(--text-a); display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            margin: 50px auto; cursor: pointer; transition: 0.2s;
        }
        .start-circle:active { transform: scale(0.95); background: var(--text-a); color: white; }
        .start-icon { font-size: 32px; margin-bottom: 5px; }

        .input-area { width: 100%; padding: 0 30px; }
        input[type="text"] {
            width: 100%; padding: 15px; margin-bottom: 15px; border: none;
            background: #F5F5F5; border-radius: 12px; text-align: center;
            font-size: 16px; color: #333; outline: none;
        }
        input::placeholder { color: #bbb; } /* æš—æ–‡æ ·å¼ */
        .help-btn { text-align: center; margin-top: 20px; color: var(--text-sub); font-size: 14px; text-decoration: underline; cursor: pointer; }

        /* === æ²‰æµ¸å¼åˆ†å±è®¡æ—¶ === */
        #screen-timer { padding: 0; background: #fff; }
        .split-container { flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%; }
        .pane {
            width: 100%; display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            transition: flex 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden;
        }
        #pane-top { background-color: var(--bg-a); color: var(--text-a); border-bottom: 1px solid rgba(0,0,0,0.05); }
        #pane-bottom { background-color: var(--bg-b); color: var(--text-b); }

        .pane.active { flex: 2.5; } 
        .pane.inactive { flex: 1; opacity: 0.6; filter: grayscale(0.2); } 
        .pane.equal { flex: 1; opacity: 1; filter: none; } 

        .pane-label { font-size: 10px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; opacity: 0.5; }
        .pane-name { font-size: 36px; font-weight: 600; margin-bottom: 5px; }
        .pane-role { font-size: 14px; opacity: 0.8; margin-bottom: 20px; }
        .pane-timer { font-size: 64px; font-weight: 300; font-variant-numeric: tabular-nums; margin: 10px 0; letter-spacing: -2px; display: none; }
        .pane.active .pane-timer, .pane.equal .pane-timer { display: block; animation: fadeIn 0.5s; }
        .pane-hint { font-size: 14px; line-height: 1.5; max-width: 70%; text-align: center; margin-top: 20px; opacity: 0.8; }

        .breath-icon { display: flex; gap: 4px; height: 20px; align-items: center; display: none; }
        .pane.active .breath-icon { display: flex; }
        .bar { width: 4px; background: currentColor; border-radius: 4px; animation: breath 1s infinite ease-in-out; }
        @keyframes breath { 0%, 100% { height: 8px; opacity: 0.5; } 50% { height: 20px; opacity: 1; } }

        .float-skip {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 24px; border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); color: #666; font-size: 14px;
            z-index: 100; cursor: pointer; border: 1px solid #eee;
        }

        /* === è¯¦æƒ…é¡µ (ä¼˜åŒ–ç‰ˆ) === */
        .detail-header { margin-bottom: 20px; display: flex; align-items: center; padding-right: 10px; }
        /* æ ‡é¢˜åŠ¨æ€åŒ–ï¼Œå­—å·ç¨å°ä»¥é€‚åº”é•¿æ ‡é¢˜ */
        .detail-title { font-size: 18px; font-weight: 600; color: #333; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .detail-date { font-size: 12px; color: #999; margin-left: 10px; white-space: nowrap; }

        .full-player { background: #f1f3f5; border-radius: 12px; padding: 12px 15px; margin-bottom: 20px; display: flex; align-items: center; }
        .full-player-label { font-size: 12px; color: #666; margin-right: 10px; font-weight: bold; white-space: nowrap;}
        
        .insight-box { background: #fff; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); }
        .insight-box h4 { margin: 15px 0 8px 0; color: var(--primary); font-size: 15px; }
        .insight-box p { font-size: 14px; color: #555; line-height: 1.6; text-align: justify; margin-bottom: 10px;}
        
        /* ğŸ“¦ å¯¹è¯å›æº¯æ¨¡å— (å¸¦åº•è‰²) */
        .transcript-wrapper {
            background: #FAFAFA; border-radius: 16px; padding: 20px; /* å¢åŠ åº•è‰² */
            border: 1px solid #f0f0f0;
        }
        .chat-container { display: flex; flex-direction: column; gap: 12px; }
        .chat-bubble { 
            padding: 10px 14px; border-radius: 14px; font-size: 14px; line-height: 1.5; 
            max-width: 88%; position: relative; color: #333;
        }
        .chat-row { display: flex; flex-direction: column; }
        
        .chat-row.left { align-items: flex-start; }
        .chat-row.left .chat-bubble { background: var(--bg-a); border-top-left-radius: 4px; }
        .chat-row.left .chat-name { color: var(--text-a); align-self: flex-start; margin-left: 5px; }
        
        .chat-row.right { align-items: flex-end; }
        .chat-row.right .chat-bubble { background: var(--bg-b); border-top-right-radius: 4px; }
        .chat-row.right .chat-name { color: var(--text-b); align-self: flex-end; margin-right: 5px; }

        .chat-name { font-size: 10px; margin-bottom: 3px; font-weight: bold; opacity: 0.8; }

        /* === å†å²é¡µ === */
        .calendar-widget { background: #fff; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .cal-header { display: flex; justify-content: space-between; cursor: pointer; padding-bottom: 5px; }
        .cal-grid { display: none; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px; }
        .cal-grid.show { display: grid !important; }
        .cal-day { height: 30px; display: flex; align-items: center; justify-content: center; font-size: 13px; border-radius: 8px; position: relative; }
        .cal-day.active { background: var(--text-a); color: white; }
        .cal-day.has-data::after { content: ''; position: absolute; bottom: 3px; width: 4px; height: 4px; background: var(--text-b); border-radius: 50%; }
        
        .history-card { background: white; padding: 16px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; }

        /* === ä½¿ç”¨è¯´æ˜é¡µ === */
        #screen-help { background: #fff; }
        .help-block { margin-bottom: 30px; }
        .help-block h3 { color: var(--text-a); border-bottom: 2px solid var(--bg-a); display: inline-block; padding-bottom: 5px; margin-bottom: 10px; font-size: 16px; }
        .help-block p { font-size: 14px; color: #666; line-height: 1.6; margin-bottom: 8px; }

        /* åº•éƒ¨å¯¼èˆª */
        #tab-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 70px; background: rgba(255,255,255,0.95); border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .tab-item { flex: 1; text-align: center; color: #ccc; font-size: 24px; cursor: pointer; }
        .tab-item.active { color: var(--text-a); }

        /* å¼¹çª— */
        .modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:none; justify-content:center; align-items:center; }
        .modal-box { background:white; width:80%; border-radius:20px; padding:25px; text-align:center; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app-container">

    <div id="tab-home" class="screen active" style="justify-content: center;">
        <div style="position:absolute; top:20px; right:20px; font-size:20px; color:#ccc; cursor:pointer;" onclick="openSettings()">âš™ï¸</div>
        
        <div class="home-header">
            <div class="home-title">Mindful Talk</div>
            <div class="home-sub">Relationship Growth</div>
        </div>

        <div class="start-circle" onclick="checkPermissionAndStart()">
            <div class="start-icon">ğŸ™</div>
            <div style="font-weight:600; letter-spacing:1px;">å¼€å§‹æ²Ÿé€š</div>
        </div>

        <div class="input-area">
            <input type="text" id="nameA" placeholder="è®²è¿°è€… (A)">
            <input type="text" id="nameB" placeholder="å€¾å¬è€… (B)">
        </div>
        
        <div class="help-btn" onclick="showScreen('screen-help')">ğŸ“– ä½¿ç”¨æŒ‡å—</div>
    </div>

    <div id="screen-help" class="screen">
        <button onclick="showScreen('tab-home')" style="border:none;background:none;font-size:24px;align-self:flex-start;margin-bottom:20px;">â†</button>
        <h2 style="margin-bottom:20px;">ä½¿ç”¨æŒ‡å—</h2>
        
        <div class="help-block">
            <h3>â³ 3-2-1 è§„åˆ™</h3>
            <p><strong>3åˆ†é’Ÿ è®²è¿°</strong>ï¼šA è¡¨è¾¾æ„Ÿå—ï¼ŒB ä»…å€¾å¬ã€‚</p>
            <p><strong>2åˆ†é’Ÿ å¤è¿°</strong>ï¼šB å¤è¿°å¬åˆ°çš„å†…å®¹ï¼ŒA ä»…å€¾å¬ã€‚</p>
            <p><strong>1åˆ†é’Ÿ äº¤æµ</strong>ï¼šåˆ†äº«åŒæ–¹çš„æ„Ÿå—ï¼Œç„¶åäº¤æ¢è§’è‰²ã€‚</p>
        </div>
        
        <div class="help-block">
            <h3>ğŸ¤– AI å’¨è¯¢å¸ˆ</h3>
            <p>å½•éŸ³ç»“æŸåï¼ŒAI å°†åˆ†æå¯¹è¯é‡Œä½“ç°çš„æƒ…ç»ªã€éœ€æ±‚ï¼Œå¹¶ç»™å‡ºåŒæ–¹çš„äº’åŠ¨å»ºè®®ã€‚</p>
            <p style="font-size:12px; color:#999;">*éœ€é…ç½® API Key å¹¶ä»˜è´¹è®¢é˜…(æ¨¡æ‹Ÿ)ã€‚</p>
        </div>
    </div>

    <div id="screen-timer" class="screen">
        <div class="split-container">
            <div class="pane active" id="pane-top">
                <div class="pane-label">SPEAKER</div>
                <div class="pane-name" id="name-top">Alex</div>
                <div class="pane-role" id="role-top">è®²è¿°è€…</div>
                <div class="pane-timer" id="timer-top">03:00</div>
                <div class="breath-icon">
                    <div class="bar" style="animation-delay:0s"></div>
                    <div class="bar" style="animation-delay:0.2s"></div>
                    <div class="bar" style="animation-delay:0.4s"></div>
                </div>
                <div class="pane-hint" id="instr-top">è¯·ä¸“æ³¨è¡¨è¾¾æ„Ÿå—...</div>
            </div>
            
            <div class="pane inactive" id="pane-bottom">
                <div class="pane-timer" id="timer-bottom">03:00</div>
                <div class="breath-icon">
                    <div class="bar" style="animation-delay:0s"></div>
                    <div class="bar" style="animation-delay:0.2s"></div>
                    <div class="bar" style="animation-delay:0.4s"></div>
                </div>
                <div class="pane-hint" id="instr-bottom">...</div>
                <div class="pane-role" id="role-bottom">å€¾å¬è€…</div>
                <div class="pane-name" id="name-bottom">Jamie</div>
                <div class="pane-label">LISTENER</div>
            </div>
        </div>
        
        <div class="float-skip" onclick="skipPhase()">è·³è¿‡å½“å‰é˜¶æ®µ</div>
    </div>

    <div id="screen-interim" class="screen" style="justify-content:center; align-items:center; text-align:center;">
        <h2 id="interim-title">äº¤æ¢</h2>
        <p id="interim-desc" style="color:#888; margin-bottom:30px;">...</p>
        <button onclick="resumeFlow()" style="padding:15px 40px; background:var(--text-a); color:white; border:none; border-radius:30px; font-size:16px;">ç»§ç»­</button>
    </div>

    <div id="screen-paywall" class="screen" style="justify-content:center; align-items:center; text-align:center;">
        <div style="font-size:50px; margin-bottom:20px;">âœ¨</div>
        <h2>å¯¹è¯å®Œæˆ</h2>
        <p style="color:#888; margin-bottom:30px;">å½•éŸ³å·²ä¿å­˜ã€‚è§£é”æ·±åº¦åˆ†ææŠ¥å‘Šã€‚</p>
        <button onclick="startBatchProcessing()" style="padding:15px 40px; background:linear-gradient(to right, #D4AF37, #FDC830); color:white; border:none; border-radius:30px; font-size:16px; font-weight:bold; box-shadow:0 5px 15px rgba(212,175,55,0.3);">è§£é”åˆ†æ (Â¥9.9)</button>
        <div onclick="saveOnly()" style="margin-top:20px; text-decoration:underline; color:#999; font-size:13px;">ä»…ä¿å­˜å½•éŸ³</div>
    </div>

    <div id="screen-detail" class="screen" style="background:#F9F9F9; z-index:50;">
        <div class="detail-header">
            <button onclick="switchTab('history')" style="border:none;background:none;font-size:24px;">â†</button>
            <div id="d-title" class="detail-title">åˆ†ææŠ¥å‘Š</div>
            <div id="d-date" class="detail-date"></div>
        </div>

        <div class="full-player">
            <span class="full-player-label">ğŸ§ å…¨ç¨‹å½•éŸ³</span>
            <audio id="d-full-audio" controls style="width:100%; height:32px; outline:none;"></audio>
        </div>

        <div class="insight-box">
            <div style="font-weight:bold; font-size:16px; margin-bottom:10px; color:var(--text-a);">ğŸ’¡ æ·±åº¦æ´å¯Ÿ</div>
            <div id="d-insight"></div>
        </div>

        <div class="transcript-wrapper">
            <div style="font-weight:bold; font-size:14px; margin-bottom:15px; color:#666;">ğŸ“ å¯¹è¯å›æº¯</div>
            <div id="d-transcript-box" class="chat-container"></div>
        </div>
    </div>

    <div id="tab-history" class="screen">
        <h2 style="margin:20px 0;">å†å²è®°å½•</h2>
        
        <div class="calendar-widget">
            <div class="cal-header" onclick="toggleCalendar()">
                <span style="font-weight:600;">ğŸ“… æŒ‰æ—¥æœŸç­›é€‰</span>
                <span style="color:#999;">â–¼</span>
            </div>
            <div class="cal-grid" id="cal-grid"></div>
            <div id="reset-filter" style="text-align:center; padding-top:10px; font-size:12px; color:var(--text-a); display:none;" onclick="resetFilter()">æ˜¾ç¤ºå…¨éƒ¨</div>
        </div>

        <div id="history-list-container"></div>
    </div>

    <div id="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="switchTab('home')">ğŸ </div>
        <div class="tab-item" id="btn-history" onclick="switchTab('history')">ğŸ“…</div>
    </div>

    <div id="modal-loading" class="modal-overlay"><div class="modal-box"><h3>AI åˆ†æä¸­...</h3><p style="color:#999; font-size:12px;">æ­£åœ¨é‡ç»„å¯¹è¯ä¸Šä¸‹æ–‡...</p></div></div>
    <div id="modal-settings" class="modal-overlay"><div class="modal-box"><h3>API Key</h3><input type="password" id="apiKeyInput" placeholder="sk-..." style="border:1px solid #eee; margin-top:10px;"><button onclick="saveSettings()" style="padding:10px 30px; background:var(--text-a); color:white; border:none; border-radius:20px; margin-top:10px;">ä¿å­˜</button><div onclick="document.getElementById('modal-settings').style.display='none'" style="margin-top:15px; color:#999;">å…³é—­</div></div></div>

</div>

<script>
    const DB_NAME = 'MindfulTalk_V25';
    let db;
    const getTodayStr = () => { const d=new Date(); return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; };
    
    function initDB() {
        const r = indexedDB.open(DB_NAME, 1);
        r.onupgradeneeded = e => { db = e.target.result; if(!db.objectStoreNames.contains('sessions')) db.createObjectStore('sessions', {keyPath: 'id'}); };
        r.onsuccess = e => { 
            db = e.target.result; 
            const tx = db.transaction(['sessions'], 'readonly');
            if(tx.objectStore('sessions').count().result === 0) seedMockData();
            loadHistoryList();
        };
    }
    function seedMockData() {
        const mockBlob = new Blob([""], { type: 'audio/webm' });
        const mocks = [{ 
            id: 1001, date: getTodayStr(), timestamp: Date.now(), 
            title: "å…³äºå‘¨æœ«å®‰æ’çš„æ²Ÿé€š", 
            insight: "<h4>ğŸŒ¡ï¸ æƒ…ç»ªåº•è‰²</h4><p>æ¸©æš–ä½†ç•¥å¸¦ç„¦è™‘ã€‚</p><h4>ğŸ’¡ åŒæ–¹è´´å£«</h4><p>Alex: è¡¨è¾¾éœ€æ±‚å¾ˆæ¸…æ™°ã€‚Jamie: å€¾å¬å¾ˆè€å¿ƒã€‚</p>",
            segments: [
                {speaker:"Alex", role:"è®²è¿°", text:"æˆ‘è§‰å¾—è¿™å‘¨å¾ˆç´¯ã€‚", blob:mockBlob}, 
                {speaker:"Jamie", role:"å¤è¿°", text:"ä½ è§‰å¾—ç´¯ï¼Ÿ", blob:mockBlob}
            ] 
        }];
        const tx = db.transaction(['sessions'], 'readwrite');
        mocks.forEach(m => tx.objectStore('sessions').add(m));
        tx.oncomplete = () => loadHistoryList();
    }
    window.onload = initDB;

    let names = { A: "A", B: "B" };
    let phases = [], phaseIdx = 0, timerInterval;
    let mediaRecorder, audioChunks = [], sessionSegments = [];
    let supportedMime = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';

    function checkPermissionAndStart() {
        names.A = document.getElementById('nameA').value.trim() || "A";
        names.B = document.getElementById('nameB').value.trim() || "B";
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            mediaRecorder = new MediaRecorder(stream, { mimeType: supportedMime });
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: supportedMime });
                const p = phases[phaseIdx];
                sessionSegments.push({ blob: blob, speaker: p.act==='BOTH'?'Both':p.act, role: p.role, text: "" });
                proceedNext();
            };
            startSession();
        }).catch(e => alert("éœ€éº¦å…‹é£æƒé™"));
    }

    function startSession() {
        sessionSegments = [];
        phases = [
            { act: names.A, role: 'è®²è¿°', t: 180, s: "ä¸“æ³¨è¡¨è¾¾æ„Ÿå—", l: "å…¨ç¥è´¯æ³¨å€¾å¬" },
            { act: names.B, role: 'å¤è¿°', t: 120, s: "åƒé•œå­ä¸€æ ·å¤è¿°", l: "ç¡®è®¤ç†è§£" },
            { act: 'BOTH', role: 'äº¤æµ', t: 60, s: "æ ¸å¯¹æ„Ÿå—", l: "æ ¸å¯¹æ„Ÿå—" },
            { swap: true },
            { act: names.B, role: 'è®²è¿°', t: 180, s: "è¯´å‡ºæ·±å±‚æ„Ÿå—", l: "å…¨ç„¶åŒåœ¨" },
            { act: names.A, role: 'å¤è¿°', t: 120, s: "å¤è¿°å¯¹æ–¹çš„å†…å®¹", l: "æ„Ÿå—è¢«å¬è§" },
            { act: 'BOTH', role: 'äº¤æµ', t: 60, s: "æ€»ç»“å¯¹è¯", l: "æ€»ç»“å¯¹è¯" }
        ];
        phaseIdx = 0; showScreen('screen-interim'); setupInterim();
    }

    function setupInterim() {
        const p = phases[phaseIdx];
        if(phaseIdx===0) {
            document.getElementById('interim-title').innerText = "å‡†å¤‡å¼€å§‹";
            document.getElementById('interim-desc').innerHTML = `ç”± <b>${names.A}</b> å…ˆè®²è¿°`;
        } else if(p.swap) {
            document.getElementById('interim-title').innerText = "äº¤æ¢è§’è‰²";
            document.getElementById('interim-desc').innerHTML = `è½®åˆ° <b>${names.B}</b> è®²è¿°`;
        }
    }

    function resumeFlow() {
        if(phases[phaseIdx].swap) { phaseIdx++; resumeFlow(); return; }
        showScreen('screen-timer'); audioChunks = [];
        if(mediaRecorder.state==='inactive') mediaRecorder.start();
        runTimer();
    }

    function runTimer() {
        const p = phases[phaseIdx];
        document.getElementById('name-top').innerText = names.A;
        document.getElementById('name-bottom').innerText = names.B;

        const top = document.getElementById('pane-top');
        const bot = document.getElementById('pane-bottom');
        const tTop = document.getElementById('timer-top');
        const tBot = document.getElementById('timer-bottom');

        top.className = "pane"; bot.className = "pane";
        tTop.innerText = formatTime(p.t); tBot.innerText = formatTime(p.t);

        if (p.act === 'BOTH') {
            top.classList.add('equal'); bot.classList.add('equal');
            document.getElementById('instr-top').innerText = p.s;
            document.getElementById('instr-bottom').innerText = p.s;
            document.getElementById('role-top').innerText = "äº¤æµä¸­";
            document.getElementById('role-bottom').innerText = "äº¤æµä¸­";
        } else if (p.act === names.A) {
            top.classList.add('active'); bot.classList.add('inactive');
            document.getElementById('instr-top').innerText = p.s;
            document.getElementById('instr-bottom').innerText = p.l;
            document.getElementById('role-top').innerText = "è®²è¿°è€…";
            document.getElementById('role-bottom').innerText = "å€¾å¬è€…";
        } else {
            bot.classList.add('active'); top.classList.add('inactive');
            document.getElementById('instr-bottom').innerText = p.s;
            document.getElementById('instr-top').innerText = p.l;
            document.getElementById('role-bottom').innerText = "è®²è¿°è€…";
            document.getElementById('role-top').innerText = "å€¾å¬è€…";
        }

        let t = p.t;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            t--; tTop.innerText = formatTime(t); tBot.innerText = formatTime(t);
            if(t<=0) finishPhase();
        }, 1000);
    }

    function formatTime(s) {
        const m = Math.floor(s/60).toString().padStart(2,'0');
        const sec = (s%60).toString().padStart(2,'0');
        return `${m}:${sec}`;
    }

    function finishPhase() { clearInterval(timerInterval); if(mediaRecorder.state==='recording') mediaRecorder.stop(); else proceedNext(); }
    function proceedNext() { phaseIdx++; if(phaseIdx >= phases.length) showScreen('screen-paywall'); else { if(phases[phaseIdx].swap) { showScreen('screen-interim'); setupInterim(); } else { audioChunks=[]; mediaRecorder.start(); runTimer(); } } }
    function skipPhase() { finishPhase(); }

    // === API ===
    async function startBatchProcessing() {
        const apiKey = localStorage.getItem('sf_api_key');
        if(!apiKey) { alert("è¯·ç‚¹å‡»é¦–é¡µå³ä¸Šè§’è®¾ç½® API Key"); return; }
        document.getElementById('modal-loading').style.display = 'flex';

        try {
            const segments = await Promise.all(sessionSegments.map(async s => {
                if(s.blob.size < 200) return {...s, text:"(æ— å£°éŸ³)"};
                const formData = new FormData();
                formData.append('file', s.blob, 'audio.webm');
                formData.append('model', 'FunAudioLLM/SenseVoiceSmall');
                const res = await fetch("https://api.siliconflow.cn/v1/audio/transcriptions", { method:"POST", headers:{"Authorization":`Bearer ${apiKey}`}, body:formData });
                const d = await res.json();
                return {...s, text: d.text || "(é™é»˜)"};
            }));

            const rawText = segments.map(s => `[é˜¶æ®µ:${s.role}, è¯´è¯äºº:${s.speaker}] ${s.text}`).join('\n');
            const prompt = `ä½ æ˜¯ä¸€ä½å®¶åº­æ²»ç–—å¸ˆã€‚è¯·å¤„ç†å½•éŸ³ç¨¿ã€‚
è¿”å› JSON:
{
  "title": "ç®€çŸ­æ ‡é¢˜(å¦‚:å…³äºXXçš„æ²Ÿé€š)", 
  "insight": "HTMLåˆ†æ(<h4>å°æ ‡é¢˜,<ul>åˆ—è¡¨)ï¼ŒåŒ…å«æƒ…ç»ªåº•è‰²ã€æ·±åº¦è§‰å¯Ÿã€åŒæ–¹è´´å£«",
  "reorganized_transcript": [ {"speaker": "Name", "text": "Content"} ]
}
æ³¨æ„ï¼šå°è¯•å°†[Both]é˜¶æ®µæ‹†åˆ†ä¸ºAå’ŒBçš„å‘è¨€ã€‚
æ–‡æœ¬ï¼š\n${rawText}`;

            const res2 = await fetch("https://api.siliconflow.cn/v1/chat/completions", {
                method:"POST", headers:{"Authorization":`Bearer ${apiKey}`,"Content-Type":"application/json"},
                body:JSON.stringify({model:"deepseek-ai/DeepSeek-V3", messages:[{role:"user",content:prompt}]})
            });
            const d2 = await res2.json();
            const aiData = JSON.parse(d2.choices[0].message.content.replace(/```json/g,'').replace(/```/g,''));
            
            const finalRecord = { 
                id: Date.now(), date: getTodayStr(), timestamp: Date.now(),
                title: aiData.title, insight: aiData.insight,
                rawSegments: segments, 
                displayTranscript: aiData.reorganized_transcript || [] 
            };
            
            const tx = db.transaction(['sessions'], 'readwrite');
            tx.objectStore('sessions').add(finalRecord);
            tx.oncomplete = () => loadDetail(finalRecord);

        } catch(e) { console.error(e); alert("åˆ†æä¸­æ–­ï¼Œä¿å­˜ä¸­ã€‚"); saveOnly(); } 
        finally { document.getElementById('modal-loading').style.display = 'none'; }
    }

    function saveOnly() { 
        const rec = { id:Date.now(), date:getTodayStr(), timestamp:Date.now(), title:"æœªåˆ†æå¯¹è¯", insight:"æ— ", rawSegments:sessionSegments, displayTranscript:[] };
        const tx = db.transaction(['sessions'], 'readwrite');
        tx.objectStore('sessions').add(rec);
        tx.oncomplete = () => loadDetail(rec);
    }

    function loadDetail(r) {
        document.getElementById('d-title').innerText = r.title; // ä¿®å¤ï¼šä½¿ç”¨åŠ¨æ€æ ‡é¢˜
        document.getElementById('d-date').innerText = r.date;
        document.getElementById('d-insight').innerHTML = r.insight;
        
        try {
            const fullBlob = new Blob(r.rawSegments.map(s=>s.blob), {type:supportedMime});
            if(fullBlob.size>100) document.getElementById('d-full-audio').src = URL.createObjectURL(fullBlob);
        } catch(e) {}

        const listToShow = (r.displayTranscript && r.displayTranscript.length > 0) ? r.displayTranscript : r.rawSegments;
        document.getElementById('d-transcript-box').innerHTML = listToShow.map((item, i) => {
            const isA = item.speaker.includes(names.A) || item.speaker === 'A';
            const align = isA ? 'left' : (item.speaker === 'Both' ? 'center' : 'right');
            
            return `
            <div class="chat-row ${align}">
                <div class="chat-name">${item.speaker}</div>
                <div class="chat-bubble">${item.text}</div>
            </div>`;
        }).join('');
        
        showScreen('screen-detail');
    }

    // List & Calendar
    let filterDate = null;
    function loadHistoryList() {
        const tx = db.transaction(['sessions'], 'readonly');
        tx.objectStore('sessions').getAll().onsuccess = e => {
            let list = e.target.result.sort((a,b)=>b.timestamp-a.timestamp);
            renderCalendar(list);
            if(filterDate) list = list.filter(i => i.date === filterDate);
            document.getElementById('history-list-container').innerHTML = list.map(i => `
                <div class="history-card" onclick="fetchAndShow(${i.id})">
                    <div style="font-size:24px;margin-right:15px;">${i.title.includes('æœªåˆ†æ')?'ğŸ™':'âœ¨'}</div>
                    <div style="flex:1;"><div style="font-weight:600;color:#333;">${i.title}</div><div style="font-size:12px;color:#999;">${i.date}</div></div>
                </div>
            `).join('') || `<div style="text-align:center;color:#ccc;margin-top:20px;">æš‚æ— è®°å½•</div>`;
            document.getElementById('reset-filter').style.display = filterDate ? 'block' : 'none';
        };
    }
    
    function renderCalendar(list) {
        const grid = document.getElementById('cal-grid'); grid.innerHTML = '';
        const today = new Date(); const days = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
        const dataSet = new Set(list.map(i=>i.date));
        for(let d=1; d<=days; d++) {
            const dateStr = `${today.getFullYear()}/${String(today.getMonth()+1).padStart(2,'0')}/${String(d).padStart(2,'0')}`;
            const el = document.createElement('div'); el.className = 'cal-day ' + (dataSet.has(dateStr)?'has-data':'');
            if(filterDate === dateStr) el.classList.add('active');
            el.innerText = d; el.onclick = () => { filterDate = dateStr; loadHistoryList(); };
            grid.appendChild(el);
        }
    }
    function toggleCalendar() { document.getElementById('cal-grid').classList.toggle('show'); }
    function resetFilter() { filterDate = null; loadHistoryList(); }
    window.fetchAndShow = id => { const tx = db.transaction(['sessions'], 'readonly'); tx.objectStore('sessions').get(id).onsuccess = e => loadDetail(e.target.result); }

    function switchTab(t) {
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(i=>i.classList.remove('active'));
        document.getElementById('btn-'+t).classList.add('active');
        const hideTabs = ['screen-timer','screen-interim','screen-paywall'];
        document.getElementById('tab-bar').style.display = hideTabs.includes('tab-'+t) ? 'none' : 'flex';
        if(t==='home') showScreen('tab-home');
        if(t==='history') { showScreen('tab-history'); loadHistoryList(); }
    }
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const hideTabs = ['screen-timer','screen-interim','screen-paywall','screen-help'];
        document.getElementById('tab-bar').style.display = hideTabs.includes(id) ? 'none' : 'flex';
    }
    function openSettings() { document.getElementById('modal-settings').style.display='flex'; document.getElementById('apiKeyInput').value=localStorage.getItem('sf_api_key')||''; }
    function saveSettings() { localStorage.setItem('sf_api_key', document.getElementById('apiKeyInput').value.trim()); document.getElementById('modal-settings').style.display='none'; }
</script>
</body>
</html>