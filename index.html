<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mindful Talk (V19 Stable)</title>
    <style>
        :root {
            --primary: #8FA87A; --primary-dark: #6C8558; --accent: #E6B450;
            --bg-body: #F7F8FA; --bg-card: #FFFFFF;
            --text-main: #333333; --text-sub: #888888;
            --shadow-card: 0 8px 24px rgba(0,0,0,0.05);
            --color-a: #8FA87A; --bg-a: #F1F6EE;
            --color-b: #E08C66; --bg-b: #FFF5F0;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", Roboto, sans-serif; background-color: #222; color: var(--text-main); margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        #app-container { width: 100%; max-width: 420px; height: 100%; background: var(--bg-body); position: relative; display: flex; flex-direction: column; }
        .screen { flex: 1; position: relative; overflow-y: auto; padding: 24px; padding-bottom: 100px; display: none; flex-direction: column; animation: fadeIn 0.4s ease; }
        .screen.active { display: flex; }
        
        /* é¦–é¡µ */
        .home-header { margin-top: 40px; text-align: center; }
        .home-header h1 { font-size: 28px; color: var(--primary-dark); margin: 0; }
        .start-btn-wrapper { position: relative; width: 150px; height: 150px; margin: 30px auto; }
        .big-btn { width: 100%; height: 100%; border-radius: 50%; border: none; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; font-size: 18px; font-weight: 600; box-shadow: 0 15px 40px rgba(143,168,122,0.3); cursor: pointer; position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.2s; }
        .big-btn:active { transform: scale(0.96); }
        .pulse-ring { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 1px solid var(--primary); animation: pulse 2.5s infinite; z-index: 1; pointer-events: none; }
        
        .input-group { background: var(--bg-card); padding: 20px; border-radius: 20px; box-shadow: var(--shadow-card); width: 100%; margin-top: 20px; }
        input[type="text"], input[type="password"] { width: 100%; padding: 14px; margin: 6px 0; border: 1px solid transparent; background: #F9F9F9; border-radius: 12px; font-size: 16px; text-align: center; outline: none; }
        input:focus { background: #fff; box-shadow: 0 0 0 2px var(--primary); }
        .help-link { text-align: center; margin-top: 15px; font-size: 13px; color: var(--text-sub); text-decoration: underline; opacity: 0.8; }

        /* è®¡æ—¶ */
        .timer-wrapper { position: relative; width: 220px; height: 220px; margin: 20px auto; }
        svg.timer-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        circle { fill: none; stroke-width: 6; stroke-linecap: round; }
        .ring-bg { stroke: #E0E0E0; opacity: 0.3; }
        .ring-progress { stroke: var(--primary); stroke-dasharray: 700; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }
        
        .role-card { background: var(--bg-card); border-radius: 16px; padding: 15px; margin-bottom: 12px; border-left: 5px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-card); transition: 0.3s; }
        .role-card.active-a { border-left-color: var(--color-a); background: var(--bg-a); transform: scale(1.02); }
        .role-card.active-b { border-left-color: var(--color-b); background: var(--bg-b); transform: scale(1.02); }
        .role-card.inactive { opacity: 0.5; filter: grayscale(1); }

        /* è¯¦æƒ…ä¸å†å² */
        .detail-card { background: var(--bg-card); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow-card); }
        .section-title { font-size: 14px; font-weight: 700; color: var(--text-sub); margin-bottom: 15px; display: block; border-left: 3px solid var(--primary); padding-left: 10px; }
        .insight-content h4 { margin: 15px 0 8px 0; color: var(--primary-dark); font-size: 16px; background: #f4f8f4; padding: 8px; border-radius: 8px; }
        .insight-content li { margin-bottom: 5px; }
        
        .chat-bubble { padding: 14px; border-radius: 18px; font-size: 15px; line-height: 1.6; position: relative; margin-bottom: 15px; max-width: 85%; }
        .bubble-left { background: var(--bg-a); border-top-left-radius: 4px; margin-right: auto; }
        .bubble-right { background: var(--bg-b); border-top-right-radius: 4px; margin-left: auto; }
        .bubble-tag { font-size: 11px; font-weight: bold; opacity: 0.7; display: block; text-transform: uppercase; margin-bottom: 4px; }
        
        /* æ—¥å† */
        .cal-header { display: flex; justify-content: space-between; padding: 10px 0; cursor: pointer; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px; display: none; }
        .cal-grid.show { display: grid; }
        .cal-day { height: 32px; display: flex; align-items: center; justify-content: center; font-size: 13px; border-radius: 8px; position: relative; }
        .cal-day.active { background: var(--primary); color: white; }
        .cal-day.has-data::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: var(--accent); border-radius: 50%; }
        .cal-day.active.has-data::after { background: white; }

        .history-item { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow-card); display: flex; align-items: center; }
        .h-icon { width: 44px; height: 44px; border-radius: 12px; background: #F0F2F5; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; }

        /* åº•éƒ¨å¯¼èˆª */
        #tab-bar { position: absolute; bottom: 20px; left: 20px; right: 20px; height: 70px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 35px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); display: flex; justify-content: space-around; align-items: center; z-index: 999; }
        .tab-item { flex: 1; text-align: center; color: #BBB; font-size: 24px; transition: 0.3s; }
        .tab-item.active { color: var(--primary-dark); transform: scale(1.1); }

        /* é€šç”¨æŒ‰é’® */
        .btn-full { width: 100%; padding: 16px; border-radius: 50px; border: none; background: var(--primary); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .settings-icon { position: absolute; top: 20px; left: 20px; font-size: 24px; color: #ccc; cursor: pointer; z-index: 100; }
        
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 85%; max-width: 320px; padding: 25px; border-radius: 24px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }

        @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 0; } 100% { transform: scale(0.9); opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app-container">
    <div id="tab-home" class="screen active" style="align-items: center; justify-content: center;">
        <div class="settings-icon" onclick="openSettings()">âš™ï¸</div>
        <div class="home-header"><h1>Mindful Talk</h1><p style="color:var(--text-sub); margin-top:5px; letter-spacing:2px;">RELATIONSHIP GROWTH</p></div>
        <div class="start-btn-wrapper">
            <div class="pulse-ring"></div>
            <button class="big-btn" onclick="checkPermissionAndStart()">
                <span style="font-size: 32px; margin-bottom: 5px;">ğŸ™</span>å¼€å§‹
            </button>
        </div>
        <div class="help-link" onclick="showScreen('screen-help')">ğŸ‘‰ å¦‚ä½•ä½¿ç”¨æœ¬åº”ç”¨ï¼Ÿ</div>
        <div class="input-group">
            <input type="text" id="nameA" placeholder="æ‚¨çš„åå­— (A / è®²è¿°è€…)">
            <input type="text" id="nameB" placeholder="ä¼´ä¾£åå­— (B / å€¾å¬è€…)">
        </div>
    </div>

    <div id="screen-help" class="screen" style="background: #F7F8FA;">
        <div style="margin-bottom:20px;"><button onclick="showScreen('tab-home')" style="border:none; background:none; font-size:24px;">â†</button> <span style="font-size:20px; font-weight:bold;">ä½¿ç”¨æŒ‡å—</span></div>
        <div class="detail-card">
            <h4>â³ 3-2-1 æ²Ÿé€šæ³•åˆ™</h4>
            <p style="font-size:14px; color:#555;">1. <strong>Aè®²è¿°(3åˆ†é’Ÿ)</strong>ï¼šåªè°ˆæ„Ÿå—ï¼Œä¸æŒ‡è´£ã€‚<br>2. <strong>Bå¤è¿°(2åˆ†é’Ÿ)</strong>ï¼šç¡®è®¤ç†è§£ï¼Œä¸è¾©è§£ã€‚<br>3. <strong>äº¤æµ(1åˆ†é’Ÿ)</strong>ï¼šæ ¸å¯¹åäº¤æ¢è§’è‰²ã€‚</p>
        </div>
        <div class="detail-card">
            <h4>ğŸ¤– AI å’¨è¯¢å¸ˆ</h4>
            <p style="font-size:14px; color:#555;">å¯¹è¯ç»“æŸåï¼ŒAI å°†åˆ†æä½ ä»¬çš„æƒ…ç»ªæ¨¡å¼ã€ä¾æ‹éœ€æ±‚ï¼Œå¹¶ç»™å‡ºéæš´åŠ›æ²Ÿé€šå»ºè®®ã€‚</p>
        </div>
    </div>

    <div id="screen-timer" class="screen">
        <div class="timer-wrapper">
            <svg class="timer-svg"><circle class="ring-bg" cx="110" cy="110" r="100"></circle><circle class="ring-progress" id="timer-ring" cx="110" cy="110" r="100"></circle></svg>
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center;">
                <div id="round-badge" style="font-size:12px; color:#999;">ROUND 1</div>
                <div id="time-display" style="font-size:48px; color:var(--text-main);">03:00</div>
            </div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <div class="role-card" id="card-top"><div><div style="font-size:10px; color:#999;">SPEAKER</div><b id="name-top">A</b></div><div style="font-size:13px;" id="instr-top">...</div></div>
            <div class="role-card" id="card-bottom"><div><div style="font-size:10px; color:#999;">LISTENER</div><b id="name-bottom">B</b></div><div style="font-size:13px;" id="instr-bottom">...</div></div>
        </div>
        <div style="text-align:center;"><button onclick="skipPhase()" style="border:1px solid #eee; background:white; padding:8px 20px; border-radius:20px; color:#999;">è·³è¿‡é˜¶æ®µ</button></div>
    </div>

    <div id="screen-interim" class="screen" style="justify-content:center; text-align:center;">
        <h2 id="interim-title">äº¤æ¢</h2>
        <p id="interim-desc" style="color:var(--text-sub); margin-bottom:30px;">...</p>
        <button class="btn-full" onclick="resumeFlow()">ç»§ç»­</button>
    </div>

    <div id="screen-paywall" class="screen" style="justify-content:center; text-align:center;">
        <div style="font-size:60px; margin-bottom:20px;">âœ¨</div>
        <h2>å¯¹è¯å®Œæˆ</h2>
        <p style="color:var(--text-sub); margin-bottom:40px;">ç‚¹å‡»ç”Ÿæˆæ·±åº¦å¿ƒç†åˆ†ææŠ¥å‘Šã€‚</p>
        <button class="btn-full" style="background: linear-gradient(135deg, var(--accent), #FDC830);" onclick="startBatchProcessing()">ç”Ÿæˆ AI æ´å¯Ÿ (API)</button>
        <button onclick="saveOnly()" style="background:none; border:none; color:#bbb; margin-top:20px; text-decoration:underline;">ä»…ä¿å­˜å½•éŸ³</button>
    </div>

    <div id="screen-detail" class="screen" style="background:#F7F8FA; z-index:100;">
        <div style="margin-bottom:20px;"><button onclick="switchTab('history')" style="background:white; width:40px; height:40px; border-radius:50%; border:none; box-shadow:var(--shadow-card);">â†</button> <span style="margin-left:10px; font-weight:bold;">åˆ†ææŠ¥å‘Š</span> <span id="d-date" style="float:right; font-size:12px; color:#999; margin-top:10px;"></span></div>
        <div class="detail-card"><span class="section-title">ğŸ§ å…¨ç¨‹å›æ”¾</span><audio id="d-full-audio" controls style="width:100%; height:36px;"></audio></div>
        <div class="detail-card" style="border-top:3px solid var(--accent);"><span class="section-title">ğŸ’¡ æ·±åº¦æ´å¯Ÿ</span><div id="d-insight" class="insight-content"></div></div>
        <div class="detail-card"><span class="section-title">ğŸ“ é€å­—ç¨¿</span><div id="d-transcript-box"></div></div>
    </div>

    <div id="tab-history" class="screen">
        <h2 style="margin:20px 0;">æˆé•¿æ¡£æ¡ˆ</h2>
        <div class="detail-card" style="padding:15px;">
            <div class="cal-header" onclick="toggleCalendar()"><span style="font-weight:600;">ğŸ“… æŒ‰æ—¥æœŸç­›é€‰</span><span>â–¼</span></div>
            <div class="cal-grid" id="cal-grid"></div>
            <div id="reset-filter-btn" style="text-align:center; padding-top:10px; font-size:12px; color:var(--primary); display:none;" onclick="resetFilter()">æ˜¾ç¤ºå…¨éƒ¨</div>
        </div>
        <div id="history-list-container" style="padding-bottom:20px;"></div>
    </div>

    <div id="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="switchTab('home')">ğŸ </div>
        <div class="tab-item" id="btn-history" onclick="switchTab('history')">ğŸ“…</div>
    </div>

    <div id="modal-loading" class="modal-overlay"><div class="modal-box"><div style="font-size:30px;animation:pulse 1s infinite;">ğŸ§ </div><h3 id="loading-txt">AI åˆ†æä¸­...</h3></div></div>
    <div id="modal-settings" class="modal-overlay"><div class="modal-box"><h3>API è®¾ç½®</h3><input type="password" id="apiKeyInput" placeholder="sk-..." style="margin-bottom:15px;"><button class="btn-full" onclick="saveSettings()">ä¿å­˜</button><button onclick="document.getElementById('modal-settings').style.display='none'" style="border:none; background:none; color:#999; margin-top:10px;">å…³é—­</button></div></div>
</div>

<script>
    // === 1. æ•°æ®åº“ä¸æ—¥æœŸå·¥å…· ===
    const DB_NAME = 'MindfulTalk_V19';
    let db;
    // ç»Ÿä¸€æ—¥æœŸæ ¼å¼åŒ–å‡½æ•° (YYYY/MM/DD)
    const getTodayStr = () => { const d=new Date(); return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; };
    
    function initDB() {
        const r = indexedDB.open(DB_NAME, 1);
        r.onupgradeneeded = e => { db = e.target.result; if(!db.objectStoreNames.contains('sessions')) db.createObjectStore('sessions', {keyPath: 'id'}); };
        r.onsuccess = e => { 
            db = e.target.result; 
            const tx = db.transaction(['sessions'], 'readonly');
            const req = tx.objectStore('sessions').count();
            req.onsuccess = () => { if(req.result === 0) seedMockData(); else loadHistoryList(); };
        };
    }
    
    function seedMockData() {
        const mockBlob = new Blob([""], { type: 'audio/webm' });
        const mocks = [{ 
            id: 1001, date: getTodayStr(), timestamp: Date.now(), 
            title: "æ¼”ç¤ºï¼šå®¶åŠ¡åˆ†é…æ²Ÿé€š", 
            insight: "<h4>ğŸ’¡ æ¼”ç¤ºæ•°æ®</h4><p>è¿™æ˜¯ç³»ç»Ÿç”Ÿæˆçš„æ¼”ç¤ºè®°å½•ã€‚AI åˆ†æå°†åŒ…å«ï¼š<br>â€¢ æƒ…ç»ªåº•è‰²è¯†åˆ«<br>â€¢ ä¾æ‹éœ€æ±‚åˆ†æ<br>â€¢ å…·ä½“çš„ NVC è¯æœ¯å»ºè®®</p>",
            segments: [{speaker:"Alex", role:"è®²è¿°", text:"æˆ‘è§‰å¾—å¾ˆç´¯ã€‚", blob:mockBlob}] 
        }];
        const tx = db.transaction(['sessions'], 'readwrite');
        mocks.forEach(m => tx.objectStore('sessions').add(m));
        tx.oncomplete = () => loadHistoryList();
    }
    window.onload = initDB;

    // === 2. çŠ¶æ€å˜é‡ ===
    const COLORS = { A: '#8FA87A', B: '#E08C66', Neutral: '#888' };
    let names = { A: "A", B: "B" };
    let phases = [], phaseIdx = 0, timerInterval;
    let mediaRecorder, audioChunks = [], sessionSegments = [];
    let supportedMime = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';

    // === 3. ä¸šåŠ¡é€»è¾‘ ===
    function checkPermissionAndStart() {
        const inputA = document.getElementById('nameA').value.trim();
        const inputB = document.getElementById('nameB').value.trim();
        names.A = inputA || "A"; names.B = inputB || "B";

        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            mediaRecorder = new MediaRecorder(stream, { mimeType: supportedMime });
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: supportedMime });
                const p = phases[phaseIdx];
                sessionSegments.push({ blob: blob, speaker: p.act === 'BOTH' ? 'Both' : p.act, role: p.role, text: "" });
                proceedNext();
            };
            startSession();
        }).catch(e => alert("æ— æ³•å¼€å§‹ï¼šè¯·å…è®¸éº¦å…‹é£æƒé™"));
    }

    function startSession() {
        sessionSegments = [];
        phases = [
            { act: names.A, role: 'è®²è¿°', t: 180, s: "è¯·ä¸“æ³¨è®²è¿°æ„Ÿå—", l: "è¯·ç”¨å¿ƒå€¾å¬" },
            { act: names.B, role: 'å¤è¿°', t: 120, s: "è¯·å¤è¿°å¯¹æ–¹çš„è¯", l: "ç¡®è®¤æ˜¯å¦ç†è§£" },
            { act: 'BOTH', role: 'äº¤æµ', t: 60, s: "è‡ªç”±äº¤æµ", l: "è‡ªç”±äº¤æµ" },
            { swap: true },
            { act: names.B, role: 'è®²è¿°', t: 180, s: "è¯·ä¸“æ³¨è®²è¿°æ„Ÿå—", l: "è¯·ç”¨å¿ƒå€¾å¬" },
            { act: names.A, role: 'å¤è¿°', t: 120, s: "è¯·å¤è¿°å¯¹æ–¹çš„è¯", l: "ç¡®è®¤æ˜¯å¦ç†è§£" },
            { act: 'BOTH', role: 'äº¤æµ', t: 60, s: "æ€»ç»“", l: "æ€»ç»“" }
        ];
        phaseIdx = 0; showScreen('screen-interim'); setupInterim();
    }

    function setupInterim() {
        const p = phases[phaseIdx];
        if(phaseIdx===0) {
            document.getElementById('interim-title').innerText = "å‡†å¤‡å¼€å§‹";
            document.getElementById('interim-desc').innerText = `ç¬¬1è½®ï¼šç”± ${names.A} å…ˆè®²è¿°`;
            document.documentElement.style.setProperty('--primary', COLORS.A);
        } else if(p.swap) {
            document.getElementById('interim-title').innerText = "äº¤æ¢è§’è‰²";
            document.getElementById('interim-desc').innerText = `ç¬¬2è½®ï¼šè½®åˆ° ${names.B} è®²è¿°`;
            document.documentElement.style.setProperty('--primary', COLORS.B);
        }
    }

    function resumeFlow() {
        if(phases[phaseIdx].swap) { phaseIdx++; resumeFlow(); return; }
        showScreen('screen-timer'); audioChunks = [];
        if(mediaRecorder.state==='inactive') mediaRecorder.start();
        runTimer();
    }

    function runTimer() {
        const p = phases[phaseIdx];
        const c = p.act === names.A ? COLORS.A : (p.act === names.B ? COLORS.B : COLORS.Neutral);
        document.documentElement.style.setProperty('--primary', c);
        document.getElementById('round-badge').innerText = `ROUND ${phaseIdx<3?1:2} Â· ${p.role}`;
        document.getElementById('name-top').innerText = names.A; document.getElementById('name-bottom').innerText = names.B;
        
        const top = document.getElementById('card-top'), bot = document.getElementById('card-bottom');
        top.className = "role-card"; bot.className = "role-card";
        if(p.act===names.A) { top.classList.add('active-a'); bot.classList.add('inactive'); }
        else if(p.act===names.B) { bot.classList.add('active-b'); top.classList.add('inactive'); }
        else { top.classList.add('active-a'); bot.classList.add('active-b'); }

        document.getElementById('instr-top').innerText = (p.act===names.A||p.act==='BOTH') ? p.s : p.l;
        document.getElementById('instr-bottom').innerText = (p.act===names.B||p.act==='BOTH') ? p.s : p.l;

        let t = p.t; updateRing(t, p.t);
        clearInterval(timerInterval);
        timerInterval = setInterval(()=>{ t--; updateRing(t, p.t); if(t<=0) finishPhase(); }, 1000);
    }

    function updateRing(left, total) {
        document.getElementById('time-display').innerText = `${String(Math.floor(left/60)).padStart(2,'0')}:${String(left%60).padStart(2,'0')}`;
        document.getElementById('timer-ring').style.strokeDashoffset = 700 - (left/total)*700;
    }

    function finishPhase() { clearInterval(timerInterval); if(mediaRecorder.state==='recording') mediaRecorder.stop(); else proceedNext(); }
    function proceedNext() {
        phaseIdx++; if(phaseIdx >= phases.length) showScreen('screen-paywall');
        else { if(phases[phaseIdx].swap) { showScreen('screen-interim'); setupInterim(); } else { audioChunks=[]; mediaRecorder.start(); runTimer(); } }
    }
    function skipPhase() { finishPhase(); }

    // === 4. API åˆ†æä¸ä¿å­˜ (ä¿®å¤æ ¸å¿ƒ) ===
    async function startBatchProcessing() {
        const apiKey = localStorage.getItem('sf_api_key');
        if(!apiKey) { alert("è¯·ç‚¹å‡»å·¦ä¸Šè§’è®¾ç½® API Key"); return; }
        
        document.getElementById('modal-loading').style.display = 'flex';
        document.getElementById('loading-txt').innerText = "éŸ³é¢‘ä¸Šä¼ ä¸­...";

        try {
            const segments = await Promise.all(sessionSegments.map(async s => {
                if(s.blob.size < 200) return {...s, text:"(å½•éŸ³è¿‡çŸ­)"};
                const formData = new FormData();
                formData.append('file', s.blob, 'audio.webm');
                formData.append('model', 'FunAudioLLM/SenseVoiceSmall');
                const res = await fetch("https://api.siliconflow.cn/v1/audio/transcriptions", { method:"POST", headers:{"Authorization":`Bearer ${apiKey}`}, body:formData });
                const d = await res.json();
                return {...s, text: d.text || "(é™é»˜)"};
            }));

            document.getElementById('loading-txt').innerText = "AI æ·±åº¦åˆ†æ...";
            const conversation = segments.map(s => `${s.speaker}: ${s.text}`).join('\n');
            const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šEFTå’ŒNVCçš„èµ„æ·±å®¶åº­æ²»ç–—å¸ˆã€‚è¯·æ ¹æ®å¯¹è¯é€å­—ç¨¿ç”Ÿæˆæ·±åº¦å¿ƒç†åˆ†æã€‚
è¿”å›JSON: {"title":"ç®€çŸ­æ ‡é¢˜", "insight":"HTMLå†…å®¹"}
HTMLè¦æ±‚ï¼šç”¨<h4>åšå°æ ‡é¢˜ï¼Œç”¨<ul><li>åˆ—ç‚¹ã€‚åˆ†ææƒ…ç»ªåº•è‰²ã€ä¾æ‹éœ€æ±‚ã€é˜²å¾¡æœºåˆ¶ï¼Œå¹¶ç»™å‡ºNVCè¯æœ¯é‡å¡‘å»ºè®®ã€‚
å¯¹è¯ï¼š\n${conversation}`;

            const res2 = await fetch("https://api.siliconflow.cn/v1/chat/completions", {
                method:"POST", headers:{"Authorization":`Bearer ${apiKey}`,"Content-Type":"application/json"},
                body:JSON.stringify({model:"deepseek-ai/DeepSeek-V3", messages:[{role:"user",content:prompt}]})
            });
            const d2 = await res2.json();
            let content = d2.choices[0].message.content.trim();
            if (content.startsWith('```json')) content = content.replace(/^```json/, '').replace(/```$/, '');
            const ai = JSON.parse(content);
            
            saveDB(ai.title, segments, ai.insight);
        } catch(e) { 
            console.error(e); alert("AI è¿æ¥å¤±è´¥ï¼Œå°†ä»…ä¿å­˜å½•éŸ³ã€‚"); saveOnly(); 
        } finally { document.getElementById('modal-loading').style.display = 'none'; }
    }

    function saveOnly() { saveDB("æœªåˆ†æå¯¹è¯", sessionSegments.map(s=>({...s,text:"(æœªè½¬å†™)"})), "æœªåˆ†æ"); }
    
    function saveDB(title, segs, insight) {
        // æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„æ—¥æœŸæ ¼å¼
        const rec = { id:Date.now(), date: getTodayStr(), timestamp:Date.now(), title, segments:segs, insight };
        const tx = db.transaction(['sessions'], 'readwrite');
        const req = tx.objectStore('sessions').add(rec);
        
        req.onsuccess = () => {
            // ä¿å­˜æˆåŠŸåï¼Œå¼ºåˆ¶é‡ç½®ç­›é€‰å™¨ï¼Œç¡®ä¿èƒ½çœ‹åˆ°æ–°è®°å½•
            resetFilter(); 
            loadDetail(rec);
        };
        req.onerror = (e) => { alert("ä¿å­˜å¤±è´¥: " + e.target.error); };
    }

    // === 5. è¯¦æƒ…ä¸åˆ—è¡¨ ===
    let currentAudio = null;
    function loadDetail(r) {
        document.getElementById('d-date').innerText = r.date;
        document.getElementById('d-insight').innerHTML = r.insight;
        
        try {
            const fullBlob = new Blob(r.segments.map(s=>s.blob), {type:supportedMime});
            if(fullBlob.size > 100) document.getElementById('d-full-audio').src = URL.createObjectURL(fullBlob);
        } catch(e){}
        
        document.getElementById('d-transcript-box').innerHTML = r.segments.map((s,i) => `
            <div class="chat-bubble ${s.speaker===names.A?'bubble-left':'bubble-right'}">
                <span class="bubble-tag" style="color:${s.speaker===names.A?'var(--color-a)':'var(--color-b)'}">${s.speaker}</span>
                ${s.text}
                <div class="audio-btn" onclick="playSeg(this,${r.id},${i})" style="font-size:12px;color:#999;margin-top:5px;cursor:pointer;">â–¶ æ’­æ”¾æ­¤æ®µ</div>
            </div>
        `).join('');
        showScreen('screen-detail');
    }
    
    window.playSeg = (btn, id, idx) => {
        document.getElementById('d-full-audio').pause();
        if(currentAudio) currentAudio.pause();
        const tx = db.transaction(['sessions'], 'readonly');
        tx.objectStore('sessions').get(id).onsuccess = e => {
            const blob = e.target.result.segments[idx].blob;
            currentAudio = new Audio(URL.createObjectURL(blob));
            currentAudio.play();
        };
    }

    let filterDate = null;
    function loadHistoryList() {
        const tx = db.transaction(['sessions'], 'readonly');
        tx.objectStore('sessions').getAll().onsuccess = e => {
            let list = e.target.result.sort((a,b)=>b.timestamp - a.timestamp);
            renderCalendar(list);
            if(filterDate) list = list.filter(i => i.date === filterDate);
            
            document.getElementById('history-list-container').innerHTML = list.map(i => `
                <div class="history-item" onclick="fetchAndShow(${i.id})">
                    <div class="h-icon" style="background:${i.title.includes('æœªåˆ†æ')?'#eee':'var(--bg-a)'}; color:${i.title.includes('æœªåˆ†æ')?'#999':'var(--color-a)'}">${i.title.includes('æœªåˆ†æ')?'ğŸ™':'âœ¨'}</div>
                    <div style="flex:1;">
                        <div style="font-weight:600; margin-bottom:4px;">${i.title}</div>
                        <div style="font-size:12px; color:#999;">${i.date}</div>
                    </div>
                </div>
            `).join('') || `<div style="text-align:center;color:#ccc;margin-top:20px;">æš‚æ— è®°å½•</div>`;
            document.getElementById('reset-filter-btn').style.display = filterDate ? 'block' : 'none';
        };
    }

    function renderCalendar(list) {
        const grid = document.getElementById('cal-grid'); grid.innerHTML = '';
        const today = new Date(); const days = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
        const dataSet = new Set(list.map(i=>i.date)); // ç°åœ¨è¿™é‡Œçš„æ ¼å¼å’Œ getTodayStr ä¸€è‡´
        
        for(let d=1; d<=days; d++) {
            // ä½¿ç”¨å®Œå…¨ä¸€è‡´çš„æ ¼å¼åŒ–é€»è¾‘
            const dateObj = new Date(today.getFullYear(), today.getMonth(), d);
            const dateStr = `${dateObj.getFullYear()}/${String(dateObj.getMonth()+1).padStart(2,'0')}/${String(dateObj.getDate()).padStart(2,'0')}`;
            
            const el = document.createElement('div'); el.className = 'cal-day ' + (dataSet.has(dateStr)?'has-data':'');
            if(filterDate === dateStr) el.classList.add('active');
            el.innerText = d; el.onclick = () => { filterDate = dateStr; loadHistoryList(); };
            grid.appendChild(el);
        }
    }
    
    function toggleCalendar() { document.getElementById('cal-grid').classList.toggle('show'); }
    function resetFilter() { filterDate = null; loadHistoryList(); }
    window.fetchAndShow = id => { const tx = db.transaction(['sessions'], 'readonly'); tx.objectStore('sessions').get(id).onsuccess = e => loadDetail(e.target.result); }

    function switchTab(t) {
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(i=>i.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.getElementById('btn-'+t).classList.add('active');
        const hideTabs = ['screen-timer','screen-interim','screen-paywall', 'screen-help'];
        document.getElementById('tab-bar').style.display = hideTabs.includes('tab-'+t) ? 'none' : 'flex';
        if(t==='history') loadHistoryList();
    }
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const hideTabs = ['screen-timer','screen-interim','screen-paywall', 'screen-help'];
        document.getElementById('tab-bar').style.display = hideTabs.includes(id) ? 'none' : 'flex';
    }
    function openSettings() { document.getElementById('modal-settings').style.display='flex'; document.getElementById('apiKeyInput').value=localStorage.getItem('sf_api_key')||''; }
    function saveSettings() { localStorage.setItem('sf_api_key', document.getElementById('apiKeyInput').value.trim()); document.getElementById('modal-settings').style.display='none'; }
</script>
</body>
</html>