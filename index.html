<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mindful Talk (V18.0)</title>
    <style>
        :root {
            /* è«å…°è¿ªé«˜çº§è‰²ç³» */
            --primary: #8FA87A;       /* æ©„æ¦„ç»¿ */
            --primary-dark: #6C8558;
            --accent: #E6B450;        /* æš–é‡‘ */
            --bg-body: #F7F8FA;
            --bg-card: #FFFFFF;
            --text-main: #333333;
            --text-sub: #888888;
            --shadow-card: 0 8px 24px rgba(0,0,0,0.05);
            
            /* è§’è‰²è‰² */
            --color-a: #8FA87A; --bg-a: #F1F6EE;
            --color-b: #E08C66; --bg-b: #FFF5F0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #222; color: var(--text-main);
            margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;
        }

        #app-container {
            width: 100%; max-width: 420px; height: 100%;
            background: var(--bg-body);
            position: relative; display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* å±å¹•é€šç”¨ */
        .screen {
            flex: 1; position: relative; overflow-y: auto; overflow-x: hidden;
            padding: 24px; padding-bottom: 100px;
            display: none; flex-direction: column;
            animation: fadeIn 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .screen.active { display: flex; }
        .screen::-webkit-scrollbar { display: none; }

        /* é¦–é¡µä¼˜åŒ– */
        .home-header { margin-top: 40px; text-align: center; }
        .home-header h1 { font-size: 28px; font-weight: 600; color: var(--primary-dark); margin: 0; }
        
        /* æ ¸å¿ƒä¿®å¤ï¼šè¾“å…¥æ¡†å®¹å™¨ä¸å®½åº¦ */
        .input-group { 
            background: var(--bg-card); padding: 20px; border-radius: 20px; 
            box-shadow: var(--shadow-card); width: 100%; margin-top: 20px;
        }
        /* å¼ºåˆ¶ box-sizing ä¸” width 100% */
        input[type="text"], input[type="password"] {
            width: 100%; padding: 14px; margin: 6px 0; 
            border: 1px solid transparent; background: #F9F9F9; 
            border-radius: 12px; font-size: 16px; text-align: center; outline: none;
            color: var(--text-main); box-sizing: border-box; /* å…³é”® */
        }
        input[type="text"]:focus { background: #fff; box-shadow: 0 0 0 2px var(--primary); }

        .start-btn-wrapper { position: relative; width: 150px; height: 150px; margin: 30px auto 10px auto; }
        .big-btn {
            width: 100%; height: 100%; border-radius: 50%; border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; font-size: 18px; font-weight: 600;
            box-shadow: 0 15px 40px rgba(143, 168, 122, 0.3); cursor: pointer;
            position: relative; z-index: 2; transition: transform 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .big-btn:active { transform: scale(0.96); }
        .pulse-ring {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; border: 1px solid var(--primary);
            animation: pulse 2.5s infinite; z-index: 1; pointer-events: none;
        }

        /* ä½¿ç”¨è¯´æ˜é“¾æ¥ */
        .help-link { 
            text-align: center; margin-top: 15px; font-size: 13px; 
            color: var(--text-sub); text-decoration: underline; cursor: pointer; 
            opacity: 0.8;
        }

        /* è®¡æ—¶é¡µ */
        .timer-wrapper { position: relative; width: 220px; height: 220px; margin: 20px auto; }
        svg.timer-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        circle { fill: none; stroke-width: 6; stroke-linecap: round; }
        .ring-bg { stroke: #E0E0E0; opacity: 0.3; }
        .ring-progress { stroke: var(--primary); stroke-dasharray: 700; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear, stroke 0.5s ease; }
        
        .role-card {
            background: var(--bg-card); border-radius: 16px; padding: 15px 20px; margin-bottom: 12px;
            border-left: 5px solid #eee; display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow-card); transition: 0.3s;
        }
        .role-card.active-a { border-left-color: var(--color-a); background: var(--bg-a); transform: scale(1.02); }
        .role-card.active-b { border-left-color: var(--color-b); background: var(--bg-b); transform: scale(1.02); }
        .role-card.inactive { opacity: 0.5; filter: grayscale(1); }

        /* è¯¦æƒ…é¡µ */
        .detail-card { background: var(--bg-card); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow-card); }
        .section-title { font-size: 14px; font-weight: 700; color: var(--text-sub); margin-bottom: 15px; display: block; border-left: 3px solid var(--primary); padding-left: 10px; }
        
        .insight-content { font-size: 15px; line-height: 1.8; color: #444; }
        .insight-content h4 { margin: 15px 0 8px 0; color: var(--primary-dark); font-size: 16px; background: #f4f8f4; padding: 8px; border-radius: 8px; }
        .insight-content strong { color: #333; font-weight: 600; }
        .insight-content ul { padding-left: 20px; margin: 5px 0; }
        .insight-content li { margin-bottom: 8px; }

        .chat-bubble { padding: 14px 18px; border-radius: 18px; font-size: 15px; line-height: 1.6; max-width: 85%; position: relative; margin-bottom: 15px; }
        .bubble-left { background: var(--bg-a); border-top-left-radius: 4px; margin-right: auto; }
        .bubble-right { background: var(--bg-b); border-top-right-radius: 4px; margin-left: auto; }
        .bubble-tag { font-size: 11px; font-weight: bold; opacity: 0.7; margin-bottom: 4px; display: block; text-transform: uppercase; }

        /* ä½¿ç”¨è¯´æ˜é¡µæ ·å¼ */
        .help-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow-card); }
        .help-card h3 { color: var(--primary-dark); margin: 0 0 10px 0; font-size: 16px; }
        .help-card p { font-size: 14px; color: #555; line-height: 1.6; margin: 0; }
        .step-num { display: inline-block; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; margin-right: 5px; }

        /* åº•éƒ¨å¯¼èˆª */
        #tab-bar {
            position: absolute; bottom: 20px; left: 20px; right: 20px; height: 70px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-radius: 35px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: center; z-index: 999;
        }
        .tab-item { flex: 1; text-align: center; color: #BBB; font-size: 24px; transition: 0.3s; }
        .tab-item.active { color: var(--primary-dark); transform: scale(1.1); }

        /* é€šç”¨æŒ‰é’® */
        .btn-full {
            width: 100%; padding: 16px; border-radius: 50px; border: none;
            background: var(--primary); color: white; font-size: 16px; font-weight: 600;
            box-shadow: 0 8px 20px rgba(143, 168, 122, 0.4); cursor: pointer; transition: 0.2s;
        }
        .btn-full:active { transform: scale(0.98); }
        .settings-icon { position: absolute; top: 20px; left: 20px; font-size: 24px; color: #ccc; cursor: pointer; z-index: 100; }

        /* å¼¹çª—ä¼˜åŒ– */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        /* ä¿®å¤ï¼šä½¿ç”¨ box-sizing å’Œ max-width é˜²æ­¢æº¢å‡º */
        .modal-box { 
            background: white; width: 85%; max-width: 320px; 
            padding: 25px; border-radius: 24px; text-align: center; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            box-sizing: border-box; 
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 0; } 100% { transform: scale(0.9); opacity: 0; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* å†å²åˆ—è¡¨ */
        .history-item { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow-card); display: flex; align-items: center; }
        .h-icon { width: 44px; height: 44px; border-radius: 12px; background: #F0F2F5; color: #999; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; }
        .h-icon.done { background: var(--bg-a); color: var(--color-a); }
        /* æ—¥å† */
        .cal-header { display: flex; justify-content: space-between; padding: 10px 0; cursor: pointer; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px; display: none; }
        .cal-grid.show { display: grid; animation: slideDown 0.3s ease; }
        .cal-day { height: 32px; display: flex; align-items: center; justify-content: center; font-size: 13px; border-radius: 8px; position: relative; }
        .cal-day.active { background: var(--primary); color: white; }
        .cal-day.has-data::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: var(--accent); border-radius: 50%; }
        .cal-day.active.has-data::after { background: white; }

    </style>
</head>
<body>

<div id="app-container">

    <div id="tab-home" class="screen active" style="align-items: center; justify-content: center;">
        <div class="settings-icon" onclick="openSettings()">âš™ï¸</div>
        <div class="home-header">
            <h1>Mindful Talk</h1>
            <p style="letter-spacing: 2px; color: var(--text-sub); margin-top: 5px;">RELATIONSHIP GROWTH</p>
        </div>
        <div class="start-btn-wrapper">
            <div class="pulse-ring"></div>
            <button class="big-btn" onclick="checkPermissionAndStart()">
                <span style="font-size: 32px; margin-bottom: 5px;">ğŸ™</span>
                å¼€å§‹
            </button>
        </div>
        
        <div class="help-link" onclick="showScreen('screen-help')">ğŸ‘‰ å¦‚ä½•ä½¿ç”¨æœ¬åº”ç”¨ï¼Ÿ</div>

        <div class="input-group">
            <input type="text" id="nameA" placeholder="æ‚¨çš„åå­— (A / è®²è¿°è€…)">
            <input type="text" id="nameB" placeholder="ä¼´ä¾£åå­— (B / å€¾å¬è€…)">
        </div>
    </div>

    <div id="screen-help" class="screen" style="background: #F7F8FA;">
        <div style="margin-bottom: 20px; display: flex; align-items: center;">
            <button onclick="showScreen('tab-home')" style="border:none; background:none; font-size:24px; margin-right:10px;">â†</button>
            <h2 style="margin:0; font-size: 20px; color: var(--text-main);">ä½¿ç”¨æŒ‡å—</h2>
        </div>

        <div class="help-card">
            <h3>â³ 3-2-1 æ²Ÿé€šæ³•åˆ™</h3>
            <p><span class="step-num">1</span><strong>A è®²è¿° (3åˆ†é’Ÿ)</strong>ï¼šA ä¸“æ³¨è¡¨è¾¾æ„Ÿå—ï¼Œä½¿ç”¨â€œæˆ‘æ„Ÿåˆ°...â€å¥å¼ã€‚B ä¿æŒæ²‰é»˜ï¼Œä¸æ‰“æ–­ã€‚</p>
            <div style="height:10px;"></div>
            <p><span class="step-num">2</span><strong>B å¤è¿° (2åˆ†é’Ÿ)</strong>ï¼šB å¤è¿°å¬åˆ°çš„å†…å®¹ï¼Œç¡®è®¤ç†è§£æ˜¯å¦å‡†ç¡®ï¼Œä¸åé©³ï¼Œä¸è¾©è§£ã€‚</p>
            <div style="height:10px;"></div>
            <p><span class="step-num">3</span><strong>è‡ªç”±äº¤æµ (1åˆ†é’Ÿ)</strong>ï¼šåŒæ–¹æ ¸å¯¹æ„Ÿå—ï¼Œç„¶åäº¤æ¢è§’è‰²ã€‚</p>
        </div>

        <div class="help-card">
            <h3>ğŸ¤– AI æ·±åº¦æ´å¯Ÿ</h3>
            <p>å¯¹è¯ç»“æŸåï¼ŒAI å°†ä½œä¸ºæ‚¨çš„â€œç§äººå’¨è¯¢å¸ˆâ€ï¼ŒåŸºäºå½•éŸ³åˆ†æï¼š</p>
            <ul style="margin: 10px 0; padding-left: 20px; color: #555; font-size: 13px;">
                <li>è¯†åˆ«è¡¨å±‚æƒ…ç»ªèƒŒåçš„æ·±å±‚éœ€æ±‚</li>
                <li>è¯„ä¼°å€¾å¬ä¸å¤è¿°çš„è´¨é‡</li>
                <li>æä¾›éæš´åŠ›æ²Ÿé€š(NVC)è¯æœ¯å»ºè®®</li>
            </ul>
        </div>

        <div class="help-card">
            <h3>ğŸ”’ éšç§å®‰å…¨</h3>
            <p>æ‰€æœ‰å½•éŸ³å’Œ API Key å‡å­˜å‚¨åœ¨æ‚¨çš„æœ¬åœ°æ‰‹æœºæµè§ˆå™¨ä¸­ã€‚API è°ƒç”¨ä»…åœ¨åˆ†ææ—¶è¿›è¡Œï¼Œä¸ä¼šç”¨äºè®­ç»ƒæ¨¡å‹ã€‚</p>
        </div>
    </div>

    <div id="screen-timer" class="screen">
        <div class="timer-wrapper">
            <svg class="timer-svg"><circle class="ring-bg" cx="110" cy="110" r="100"></circle><circle class="ring-progress" id="timer-ring" cx="110" cy="110" r="100"></circle></svg>
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center;">
                <div id="round-badge" style="font-size:12px; color:#999; letter-spacing:1px; margin-bottom:5px;">ROUND 1</div>
                <div id="time-display" style="font-size:48px; font-weight:300; color:var(--text-main);">03:00</div>
            </div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <div class="role-card" id="card-top">
                <div><div style="font-size:10px; color:#999; font-weight:700;">SPEAKER</div><div style="font-size:18px; font-weight:600;" id="name-top">A</div></div>
                <div style="font-size:13px; color:#666;" id="instr-top">...</div>
            </div>
            <div class="role-card" id="card-bottom">
                <div><div style="font-size:10px; color:#999; font-weight:700;">LISTENER</div><div style="font-size:18px; font-weight:600;" id="name-bottom">B</div></div>
                <div style="font-size:13px; color:#666;" id="instr-bottom">...</div>
            </div>
        </div>
        <div style="text-align:center;">
            <div style="font-size:12px; color:var(--primary); margin-bottom:15px;">ğŸ”´ å½•éŸ³è¿›è¡Œä¸­...</div>
            <button onclick="skipPhase()" style="border:1px solid #eee; background:white; padding:8px 20px; border-radius:20px; color:#999; font-size:12px;">è·³è¿‡é˜¶æ®µ</button>
        </div>
    </div>

    <div id="screen-interim" class="screen" style="justify-content:center; text-align:center;">
        <h2 id="interim-title" style="font-size:24px;">äº¤æ¢</h2>
        <p id="interim-desc" style="color:var(--text-sub); margin-bottom:30px;">...</p>
        <button class="btn-full" onclick="resumeFlow()">ç»§ç»­</button>
    </div>

    <div id="screen-paywall" class="screen" style="justify-content:center; text-align:center;">
        <div style="font-size:60px; margin-bottom:20px;">âœ¨</div>
        <h2 style="font-size:22px;">å¯¹è¯å®Œæˆ</h2>
        <p style="color:var(--text-sub); margin-bottom:40px;">å½•éŸ³å·²ä¿å­˜ã€‚ç‚¹å‡»ç”Ÿæˆæ·±åº¦åˆ†ææŠ¥å‘Šã€‚</p>
        <button class="btn-full" style="background: linear-gradient(135deg, var(--accent), #FDC830);" onclick="startBatchProcessing()">ç”Ÿæˆ AI æ´å¯Ÿ (API)</button>
        <button onclick="saveOnly()" style="background:none; border:none; color:#bbb; margin-top:20px; font-size:13px; text-decoration:underline;">ä»…ä¿å­˜å½•éŸ³</button>
    </div>

    <div id="screen-detail" class="screen" style="background:#F7F8FA; z-index:100;">
        <div style="display:flex; align-items:center; margin-bottom:20px;">
            <button onclick="switchTab('history')" style="background:white; width:40px; height:40px; border-radius:50%; border:none; box-shadow:var(--shadow-card);">â†</button>
            <div style="margin-left:15px;">
                <div style="font-weight:700; font-size:16px;">åˆ†ææŠ¥å‘Š</div>
                <div id="d-date" style="font-size:12px; color:#999;"></div>
            </div>
        </div>
        
        <div class="detail-card">
            <span class="section-title">ğŸ§ å…¨ç¨‹å›æ”¾</span>
            <audio id="d-full-audio" controls style="width:100%; height:36px; outline:none;"></audio>
        </div>

        <div class="detail-card" style="border-top: 3px solid var(--accent);">
            <span class="section-title">ğŸ’¡ æ·±åº¦å¿ƒç†æ´å¯Ÿ</span>
            <div id="d-insight" class="insight-content"></div>
        </div>

        <div class="detail-card">
            <span class="section-title">ğŸ“ é€å­—ç¨¿</span>
            <div id="d-transcript-box"></div>
        </div>
    </div>

    <div id="tab-history" class="screen">
        <h2 style="margin:20px 0; font-size:24px;">æˆé•¿æ¡£æ¡ˆ</h2>
        <div class="detail-card" style="padding:15px;">
            <div class="cal-header" onclick="toggleCalendar()">
                <span style="font-weight:600;">ğŸ“… æŒ‰æ—¥æœŸç­›é€‰</span>
                <span style="color:#bbb;">â–¼</span>
            </div>
            <div class="cal-grid" id="cal-grid"></div>
            <div id="reset-filter-btn" style="text-align:center; padding-top:10px; font-size:12px; color:var(--primary); display:none;" onclick="resetFilter()">æ˜¾ç¤ºå…¨éƒ¨</div>
        </div>
        <div id="history-list-container" style="padding-bottom:20px;"></div>
    </div>

    <div id="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="switchTab('home')">ğŸ </div>
        <div class="tab-item" id="btn-history" onclick="switchTab('history')">ğŸ“…</div>
    </div>

    <div id="modal-loading" class="modal-overlay"><div class="modal-box"><div style="font-size:30px;animation:pulse 1s infinite;">ğŸ§ </div><h3 id="loading-txt">AI æ·±åº¦åˆ†æä¸­...</h3></div></div>
    
    <div id="modal-settings" class="modal-overlay">
        <div class="modal-box">
            <h3>API è®¾ç½®</h3>
            <p style="font-size:12px; color:#999;">SiliconFlow / OpenAI</p>
            <input type="password" id="apiKeyInput" placeholder="sk-..." style="margin-bottom: 15px;">
            <button class="btn-full" onclick="saveSettings()" style="margin-top:5px;">ä¿å­˜</button>
            <button onclick="document.getElementById('modal-settings').style.display='none'" style="border:none; background:none; color:#999; margin-top:10px;">å…³é—­</button>
        </div>
    </div>

</div>

<script>
    const DB_NAME = 'MindfulTalk_V18';
    let db;
    function initDB() {
        const r = indexedDB.open(DB_NAME, 1);
        r.onupgradeneeded = e => { db = e.target.result; if(!db.objectStoreNames.contains('sessions')) db.createObjectStore('sessions', {keyPath: 'id'}); };
        r.onsuccess = async e => { 
            db = e.target.result; 
            const tx = db.transaction(['sessions'], 'readonly');
            if(tx.objectStore('sessions').count().result === 0) seedMockData();
            loadHistoryList();
        };
    }
    // Mock Data with Rich Text
    function seedMockData() {
        const mockBlob = new Blob([""], { type: 'audio/webm' });
        const today = new Date().toLocaleDateString();
        const mocks = [
            { 
                id: 1001, date: today, timestamp: Date.now(), 
                title: "æ¼”ç¤ºï¼šå®¶åŠ¡åˆ†é…çš„æ·±åº¦æ²Ÿé€š", 
                insight: `<h4>1. éæš´åŠ›æ²Ÿé€š (NVC) åˆ†æ</h4>
                          <ul>
                            <li><strong>è§‚å¯Ÿ</strong>: Alex æåˆ°â€œè¿™å‘¨åœ°æ²¡äººæ‹–â€ã€‚</li>
                            <li><strong>æ„Ÿå—</strong>: Alex è¡¨è¾¾äº†â€œç–²æƒ«â€å’Œâ€œå­¤å•â€ã€‚</li>
                            <li><strong>éœ€è¦</strong>: æ¸´æœ›â€œæ”¯æŒâ€å’Œâ€œå®¶åº­å…±æ‹…â€ã€‚</li>
                          </ul>
                          <h4>2. æƒ…ç»ªèšç„¦ç–—æ³• (EFT) è§†è§’</h4>
                          <p>Jamie çš„é˜²å¾¡æ€§å›ç­”ï¼ˆâ€œæˆ‘ä¹Ÿå¾ˆå¿™â€ï¼‰æ©ç›–äº†æ·±å±‚çš„<strong>ä¸å®‰å…¨æ„Ÿ</strong>â€”â€”æ‹…å¿ƒè‡ªå·±åšå¾—ä¸å¤Ÿå¥½è€Œè¢«æŒ‡è´£ã€‚</p>
                          <h4>3. å€¾å¬è´¨é‡</h4>
                          <p>Jamie åœ¨å¤è¿°æ—¶åŠ å…¥äº†è¾©è§£ï¼Œæ²¡æœ‰å®Œå…¨æ¥çº³ Alex çš„æƒ…ç»ªã€‚å»ºè®®ä¸‹æ¬¡åªå¤è¿°ï¼Œä¸è§£é‡Šã€‚</p>`,
                segments: [{speaker:"Alex", role:"è®²è¿°", text:"æˆ‘è§‰å¾—è¿™å‘¨å¾ˆç´¯ï¼Œåœ°éƒ½æ²¡äººæ‹–ã€‚", blob:mockBlob}, {speaker:"Jamie", role:"å¤è¿°", text:"ä½ è§‰å¾—ç´¯æ˜¯å› ä¸ºæ²¡äººæ‹–åœ°ï¼Ÿä½†æˆ‘è¿™å‘¨ä¹Ÿå¾ˆå¿™å•Šã€‚", blob:mockBlob}] 
            }
        ];
        const tx = db.transaction(['sessions'], 'readwrite');
        mocks.forEach(m => tx.objectStore('sessions').add(m));
    }
    window.onload = initDB;

    const COLORS = { A: '#8FA87A', B: '#E08C66', Neutral: '#888' };
    let names = { A: "Alex", B: "Jamie" }; // å†…éƒ¨é»˜è®¤å˜é‡ï¼Œä½†ç•Œé¢ä¸Šæ˜¾ç¤ºä¸ºç©º
    let phases = [], phaseIdx = 0, timerInterval;
    let mediaRecorder, audioChunks = [], sessionSegments = [];
    let supportedMime = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';

    function checkPermissionAndStart() {
        // è·å–ç”¨æˆ·è¾“å…¥ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤ A/Bï¼Œä½†ä¸æŒä¹…åŒ–åˆ°è¾“å…¥æ¡†æ˜¾ç¤º
        const inputA = document.getElementById('nameA').value.trim();
        const inputB = document.getElementById('nameB').value.trim();
        names.A = inputA || "A";
        names.B = inputB || "B";

        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            mediaRecorder = new MediaRecorder(stream, { mimeType: supportedMime });
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: supportedMime });
                const p = phases[phaseIdx];
                sessionSegments.push({ blob: blob, speaker: p.act === 'BOTH' ? 'Both' : p.act, role: p.role, text: "" });
                proceedNext();
            };
            startSession();
        }).catch(e => alert("éœ€éº¦å…‹é£æƒé™"));
    }

    function startSession() {
        sessionSegments = [];
        phases = [
            { act: names.A, role: 'è®²è¿°', t: 180, s: "è¯·ä¸“æ³¨è®²è¿°æ„Ÿå—", l: "è¯·ç”¨å¿ƒå€¾å¬" },
            { act: names.B, role: 'å¤è¿°', t: 120, s: "è¯·å¤è¿°å¯¹æ–¹çš„è¯", l: "ç¡®è®¤æ˜¯å¦ç†è§£" },
            { act: 'BOTH', role: 'äº¤æµ', t: 60, s: "è‡ªç”±äº¤æµ", l: "è‡ªç”±äº¤æµ" },
            { swap: true },
            { act: names.B, role: 'è®²è¿°', t: 180, s: "è¯·ä¸“æ³¨è®²è¿°æ„Ÿå—", l: "è¯·ç”¨å¿ƒå€¾å¬" },
            { act: names.A, role: 'å¤è¿°', t: 120, s: "è¯·å¤è¿°å¯¹æ–¹çš„è¯", l: "ç¡®è®¤æ˜¯å¦ç†è§£" },
            { act: 'BOTH', role: 'äº¤æµ', t: 60, s: "æ€»ç»“", l: "æ€»ç»“" }
        ];
        phaseIdx = 0;
        showScreen('screen-interim');
        setupInterim();
    }

    function setupInterim() {
        const p = phases[phaseIdx];
        if(phaseIdx===0) {
            document.getElementById('interim-title').innerText = "å‡†å¤‡å¼€å§‹";
            document.getElementById('interim-desc').innerText = `ç¬¬1è½®ï¼šç”± ${names.A} å…ˆè®²è¿°`;
            document.documentElement.style.setProperty('--primary', COLORS.A);
        } else if(p.swap) {
            document.getElementById('interim-title').innerText = "äº¤æ¢è§’è‰²";
            document.getElementById('interim-desc').innerText = `ç¬¬2è½®ï¼šè½®åˆ° ${names.B} è®²è¿°`;
            document.documentElement.style.setProperty('--primary', COLORS.B);
        }
    }

    function resumeFlow() {
        if(phases[phaseIdx].swap) { phaseIdx++; resumeFlow(); return; }
        showScreen('screen-timer');
        audioChunks = [];
        if(mediaRecorder.state==='inactive') mediaRecorder.start();
        runTimer();
    }

    function runTimer() {
        const p = phases[phaseIdx];
        const c = p.act === names.A ? COLORS.A : (p.act === names.B ? COLORS.B : COLORS.Neutral);
        document.documentElement.style.setProperty('--primary', c);
        
        document.getElementById('round-badge').innerText = `ROUND ${phaseIdx<3?1:2} Â· ${p.role}`;
        document.getElementById('name-top').innerText = names.A;
        document.getElementById('name-bottom').innerText = names.B;
        
        const top = document.getElementById('card-top'), bot = document.getElementById('card-bottom');
        top.className = "role-card"; bot.className = "role-card";
        if(p.act===names.A) { top.classList.add('active-a'); bot.classList.add('inactive'); }
        else if(p.act===names.B) { bot.classList.add('active-b'); top.classList.add('inactive'); }
        else { top.classList.add('active-a'); bot.classList.add('active-b'); }

        document.getElementById('instr-top').innerText = (p.act===names.A||p.act==='BOTH') ? p.s : p.l;
        document.getElementById('instr-bottom').innerText = (p.act===names.B||p.act==='BOTH') ? p.s : p.l;

        let t = p.t;
        updateRing(t, p.t);
        clearInterval(timerInterval);
        timerInterval = setInterval(()=>{ t--; updateRing(t, p.t); if(t<=0) finishPhase(); }, 1000);
    }

    function updateRing(left, total) {
        document.getElementById('time-display').innerText = `${String(Math.floor(left/60)).padStart(2,'0')}:${String(left%60).padStart(2,'0')}`;
        document.getElementById('timer-ring').style.strokeDashoffset = 700 - (left/total)*700;
    }

    function finishPhase() { clearInterval(timerInterval); if(mediaRecorder.state==='recording') mediaRecorder.stop(); else proceedNext(); }
    function proceedNext() {
        phaseIdx++;
        if(phaseIdx >= phases.length) showScreen('screen-paywall');
        else {
            if(phases[phaseIdx].swap) { showScreen('screen-interim'); setupInterim(); }
            else { audioChunks=[]; mediaRecorder.start(); runTimer(); }
        }
    }
    function skipPhase() { finishPhase(); }

    // === ğŸ’¡ æ·±åº¦åˆ†æ ===
    async function startBatchProcessing() {
        const apiKey = localStorage.getItem('sf_api_key');
        if(!apiKey) { alert("è¯·ç‚¹å‡»å·¦ä¸Šè§’è®¾ç½® API Key"); return; }
        
        document.getElementById('modal-loading').style.display = 'flex';
        document.getElementById('loading-txt').innerText = "è½¬å†™å½•éŸ³ä¸­...";

        try {
            // 1. è½¬å†™
            const segments = await Promise.all(sessionSegments.map(async s => {
                if(s.blob.size < 500) return {...s, text:"(å½•éŸ³è¿‡çŸ­)"};
                const formData = new FormData();
                formData.append('file', s.blob, 'audio.webm');
                formData.append('model', 'FunAudioLLM/SenseVoiceSmall');
                const res = await fetch("https://api.siliconflow.cn/v1/audio/transcriptions", { method:"POST", headers:{"Authorization":`Bearer ${apiKey}`}, body:formData });
                const d = await res.json();
                return {...s, text: d.text || "(é™é»˜)"};
            }));

            // 2. æ·±åº¦åˆ†æ
            document.getElementById('loading-txt').innerText = "å¿ƒç†åˆ†æä¸­...";
            
            const conversation = segments.map(s => `${s.speaker} (${s.role}): ${s.text}`).join('\n');
            const prompt = `ä½ æ˜¯ä¸€ä½æ‹¥æœ‰20å¹´ç»éªŒçš„å®¶åº­æ²»ç–—å¸ˆï¼Œç²¾é€šâ€œæƒ…ç»ªèšç„¦ç–—æ³•(EFT)â€å’Œâ€œéæš´åŠ›æ²Ÿé€š(NVC)â€ã€‚
è¯·é˜…è¯»ä»¥ä¸‹ä¼´ä¾£åœ¨â€œ3-2-1 å€¾å¬ç»ƒä¹ â€ä¸­çš„å¯¹è¯é€å­—ç¨¿ï¼Œç”Ÿæˆä¸€ä»½æ·±åº¦å¿ƒç†åˆ†ææŠ¥å‘Šã€‚
è¯·è¿”å›ä¸¥æ ¼çš„ JSON æ ¼å¼ï¼š{"title": "ä¸€ä¸ªç®€çŸ­æ¸©æš–çš„æ ‡é¢˜(å¦‚ï¼šä¸€æ¬¡å…³äºè¢«çœ‹è§çš„å°è¯•)", "insight": "HTMLå­—ç¬¦ä¸²"}

ã€Insight å­—æ®µçš„ HTML å†…å®¹è¦æ±‚ã€‘ï¼š
1. å¿…é¡»ä½¿ç”¨ <h4> ä½œä¸ºå°æ ‡é¢˜ï¼Œ<ul><li> åˆ—è¡¨å±•ç¤ºè¦ç‚¹ã€‚
2. è¯­æ°”æ¸©æš–ã€æŠ±æŒã€ä¸­ç«‹ï¼Œä¸è¦è¯„åˆ¤ï¼Œè¦åƒä¸€ä½ç¿æ™ºçš„é•¿è€…ã€‚
3. é‡ç‚¹åŒ…å«ä»¥ä¸‹æ¨¡å—ï¼š

<h4>ğŸŒ¡ï¸ æƒ…æ„Ÿæ¸©åº¦è®¡</h4>
<ul>
    <li><strong>æƒ…ç»ªåº•è‰²</strong>ï¼šç”¨ä¸€ä¸ªè¯å½¢å®¹ï¼ˆå¦‚ï¼šç„¦è™‘ä¾æ‹ã€é˜²å¾¡æ€§å›é¿ã€å®‰å…¨è¿æ¥ï¼‰ã€‚</li>
    <li><strong>å€¾å¬è´¨é‡</strong>ï¼šè¯„åˆ†(1-10)ã€‚è¯„ä»·å¤è¿°è€…(B)æ˜¯å¦çœŸçš„å¬åˆ°äº†Açš„æ„Ÿå—ï¼Œè¿˜æ˜¯åªå¬åˆ°äº†æŒ‡è´£ï¼Ÿ</li>
</ul>

<h4>ğŸ” æ·±åº¦å¿ƒç†å¯Ÿè§‰ (EFTè§†è§’)</h4>
<ul>
    <li><strong>è¡¨å±‚æƒ…ç»ª</strong>ï¼š(ä¾‹å¦‚ï¼šæ„¤æ€’ã€æŒ‡è´£)</li>
    <li><strong>æ·±å±‚æ¸´æœ›</strong>ï¼šåˆ†æè¿™äº›æƒ…ç»ªèƒŒåæœªè¢«æ»¡è¶³çš„ä¾æ‹éœ€æ±‚ï¼ˆä¾‹å¦‚ï¼šæ¸´æœ›è¢«é‡è§†ã€å®³æ€•è¢«æŠ›å¼ƒã€éœ€è¦ç¡®è®¤è‡ªå·±æ˜¯æœ‰ä»·å€¼çš„ï¼‰ã€‚è¯·åŠ¡å¿…æŒ–æ˜å‡ºâ€œæ„¤æ€’èƒŒåçš„è„†å¼±â€ã€‚</li>
</ul>

<h4>ğŸ’¬ æ²Ÿé€šæ¨¡å¼å¡ç‚¹</h4>
<p>æŒ‡å‡ºå¯¹è¯ä¸­å‡ºç°çš„é˜²å¾¡æœºåˆ¶ï¼ˆå¦‚ï¼šè¾©è§£ã€åå‡»ã€æ²‰é»˜ï¼‰ã€‚ä¾‹å¦‚ï¼šâ€œå½“Aè¡¨è¾¾ç—›è‹¦æ—¶ï¼ŒBæ€¥äºè§£é‡ŠåŸå› ï¼Œè¿™é˜»æ–­äº†æƒ…æ„ŸæµåŠ¨ã€‚â€</p>

<h4>ğŸ’¡ å’¨è¯¢å¸ˆå»ºè®® (NVCé‡å¡‘)</h4>
<p>è¯·é€‰å–å¯¹è¯ä¸­å†²çªæœ€å¤§çš„ä¸€å¥è¯ï¼Œè¿ç”¨éæš´åŠ›æ²Ÿé€š(è§‚å¯Ÿ+æ„Ÿå—+éœ€è¦+è¯·æ±‚)è¿›è¡Œé‡å†™ç¤ºèŒƒã€‚</p>
<p><strong>åŸè¯ï¼š</strong>â€œ...â€</p>
<p><strong>è¯•ç€è¿™æ ·è¯´ï¼š</strong>â€œ...â€</p>

ã€å¯¹è¯é€å­—ç¨¿ã€‘ï¼š
${conversation}`;

            const res2 = await fetch("https://api.siliconflow.cn/v1/chat/completions", {
                method:"POST", headers:{"Authorization":`Bearer ${apiKey}`,"Content-Type":"application/json"},
                body:JSON.stringify({model:"deepseek-ai/DeepSeek-V3", messages:[{role:"user",content:prompt}]})
            });
            
            const d2 = await res2.json();
            let content = d2.choices[0].message.content.trim();
            if (content.startsWith('```json')) content = content.replace(/^```json/, '').replace(/```$/, '');
            const ai = JSON.parse(content);
            
            saveDB(ai.title, segments, ai.insight);
        } catch(e) { 
            console.error(e);
            alert("åˆ†æé‡åˆ°é—®é¢˜ï¼Œå°†ä»…ä¿å­˜å½•éŸ³ã€‚\nå¯èƒ½åŸå› ï¼šAPI Key ä½™é¢ä¸è¶³æˆ–ç½‘ç»œè¶…æ—¶ã€‚"); 
            saveOnly(); 
        } 
        finally { document.getElementById('modal-loading').style.display = 'none'; }
    }

    function saveOnly() { saveDB("æœªåˆ†æå¯¹è¯", sessionSegments.map(s=>({...s,text:"(æœªè½¬å†™)"})), "æœªåˆ†æ"); }
    function saveDB(title, segs, insight) {
        const rec = { id:Date.now(), date:new Date().toLocaleDateString(), timestamp:Date.now(), title, segments:segs, insight };
        const tx = db.transaction(['sessions'], 'readwrite');
        tx.objectStore('sessions').add(rec);
        tx.oncomplete = () => loadDetail(rec);
    }

    let currentAudio = null;
    function loadDetail(r) {
        document.getElementById('d-date').innerText = r.date;
        document.getElementById('d-insight').innerHTML = r.insight;
        
        try {
            const fullBlob = new Blob(r.segments.map(s=>s.blob), {type:supportedMime});
            if(fullBlob.size > 100) document.getElementById('d-full-audio').src = URL.createObjectURL(fullBlob);
        } catch(e){}
        document.getElementById('d-transcript-box').innerHTML = r.segments.map((s,i) => `
            <div class="chat-bubble ${s.speaker===names.A?'bubble-left':'bubble-right'}">
                <span class="bubble-tag" style="color:${s.speaker===names.A?'var(--color-a)':'var(--color-b)'}">${s.speaker} Â· ${s.role}</span>
                ${s.text}
                <div class="audio-btn" onclick="playSeg(this,${r.id},${i})">â–¶ æ’­æ”¾ç‰‡æ®µ</div>
            </div>
        `).join('');
        showScreen('screen-detail');
    }
    window.playSeg = (btn, id, idx) => {
        document.getElementById('d-full-audio').pause();
        if(currentAudio) currentAudio.pause();
        document.querySelectorAll('.audio-btn').forEach(b=>b.classList.remove('playing'));
        const tx = db.transaction(['sessions'], 'readonly');
        tx.objectStore('sessions').get(id).onsuccess = e => {
            const blob = e.target.result.segments[idx].blob;
            if(blob.size<100) {alert("æ— éŸ³é¢‘");return;}
            currentAudio = new Audio(URL.createObjectURL(blob));
            currentAudio.play();
            btn.classList.add('playing');
            currentAudio.onended = () => btn.classList.remove('playing');
        };
    }

    let filterDate = null;
    function loadHistoryList() {
        const tx = db.transaction(['sessions'], 'readonly');
        tx.objectStore('sessions').getAll().onsuccess = e => {
            let list = e.target.result.sort((a,b)=>b.timestamp - a.timestamp);
            renderCalendar(list);
            if(filterDate) list = list.filter(i => i.date === filterDate);
            document.getElementById('history-list-container').innerHTML = list.map(i => `
                <div class="history-item" onclick="fetchAndShow(${i.id})">
                    <div class="h-icon ${i.title.includes('æœªåˆ†æ')?'':'done'}">${i.title.includes('æœªåˆ†æ')?'ğŸ™':'âœ¨'}</div>
                    <div style="flex:1;"><div style="font-weight:600; font-size:15px; margin-bottom:4px;">${i.title}</div><div style="font-size:12px; color:#999;">${i.date}</div></div>
                </div>
            `).join('') || `<div style="text-align:center;color:#ccc;margin-top:20px;">æš‚æ— è®°å½•</div>`;
            document.getElementById('reset-filter-btn').style.display = filterDate ? 'block' : 'none';
        };
    }
    function renderCalendar(list) {
        const grid = document.getElementById('cal-grid'); grid.innerHTML = '';
        const today = new Date(); const days = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
        const dataSet = new Set(list.map(i=>i.date));
        for(let d=1; d<=days; d++) {
            const dateStr = new Date(today.getFullYear(), today.getMonth(), d).toLocaleDateString();
            const el = document.createElement('div'); el.className = 'cal-day ' + (dataSet.has(dateStr)?'has-data':'');
            if(filterDate === dateStr) el.classList.add('active');
            el.innerText = d; el.onclick = () => { filterDate = dateStr; loadHistoryList(); };
            grid.appendChild(el);
        }
    }
    function toggleCalendar() { document.getElementById('cal-grid').classList.toggle('show'); }
    function resetFilter() { filterDate = null; loadHistoryList(); }
    window.fetchAndShow = id => { const tx = db.transaction(['sessions'], 'readonly'); tx.objectStore('sessions').get(id).onsuccess = e => loadDetail(e.target.result); }

    function switchTab(t) {
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(i=>i.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.getElementById('btn-'+t).classList.add('active');
        const hideTabs = ['screen-timer','screen-interim','screen-paywall'];
        document.getElementById('tab-bar').style.display = hideTabs.includes(id) ? 'none' : 'flex';
        // ä¿®å¤ï¼šå¦‚æœä» help å›æ¥ï¼Œç¡®ä¿ tab-bar æ˜¾ç¤º
        if(t==='home') document.getElementById('tab-bar').style.display='flex';
        if(t==='history') loadHistoryList();
    }
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        // ä½¿ç”¨è¯´æ˜é¡µéšè— tabbar
        const hideTabs = ['screen-timer','screen-interim','screen-paywall', 'screen-help'];
        document.getElementById('tab-bar').style.display = hideTabs.includes(id) ? 'none' : 'flex';
    }
    function openSettings() { document.getElementById('modal-settings').style.display='flex'; document.getElementById('apiKeyInput').value=localStorage.getItem('sf_api_key')||''; }
    function saveSettings() { localStorage.setItem('sf_api_key', document.getElementById('apiKeyInput').value.trim()); document.getElementById('modal-settings').style.display='none'; }
</script>
</body>
</html>